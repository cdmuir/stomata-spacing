---
# This template is largely functionally equivalent to that for elsevier
# The two fields that are not in the elsevier format are:
#      `corresponding_author` and `acknowledgements`
title: Spatial Coordination Of Stomatal Patterning Between Leaf Surfaces In Amphistomatous *Arabidopsis thaliana* Incurs No Photosynthetic Advantage
#date: "`r Sys.Date()`"
author:
  - name: Jacob L. Watts
    email: jwatts@colgate.edu
    corresponding_author: yes # Footnote using corresponding_author
    affiliation: Colgate University
  - name: Graham Dow
    email: graham.dow@usys.ethz.ch
    affiliation: ETH
  - name: Thomas N. Buckley
    email: tnbuckley@ucdavis.edu
    affiliation: University of California Davis
    footnote: 1 # Footnote using reference
  - name: Christopher D. Muir
    email: cdmuir@hawaii.edu
    affiliation: University of Hawaii at Manoa
    footnote: 1 # Footnote using reference
address:
  - code: Colgate University
    address: 13 Oak Drive, Hamilton, NY 13346
  - code: University of Hawaii at Manoa
    address: 2500 Campus Rd, Honolulu, HI 96822
footnote:
  - code: 1
    text: "Equal contribution"
  - code: 2
    text: "Current email address: \\href{mailto:cat@example.com}{cat@example.com}"
abstract: |
  This is the abstract.

  It consists of two paragraphs.
acknowledgements: |
  This is an acknowledgement.

  It consists of two paragraphs.
keywords:
  - amphistomy
  - Arabidopsis thaliana
  - CO$_2$ diffusion
  - finite element method
  - optimality
  - photosynthesis
  - stomata
fontsize: 12pt
#spacing: halfline # could also be oneline
#classoptions:
#  - endnotes
bibliography: stomata-spacing.bib
#csl: mycitationstyle.csl
link-citations: yes
output: 
  rticles::oup_article:
    latex_engine: xelatex
#urlcolor: orange
#linkcolor: green
#citecolor: red
header-includes:
 - \usepackage[nomarkers,tablesfirst]{endfloat} # For figures and tables at end
 - \usepackage{lineno} # For line numbering
 - \linenumbers # For line numbering
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.pos = 'p') # Places figures on pages separate from text
knitr::opts_chunk$set(out.width = '100%', dpi = 300) # Figure resolution and size
knitr::opts_chunk$set(fig.env = "figure") # Latex figure environment
knitr::opts_knit$set(root.dir = "..")
```

```{r}
source("r/header.R")
fit = readr::read_rds("objects/fit.rds")
model_var_table = readr::read_rds("objects/model_var_table.rds")
```

# Introduction

Stomatal anatomy (e.g. size, density, distribution, and patterning) and movement regulate gas exchange during photosynthesis, namely CO$_2$ assimilation and water loss through transpiration. Since waxy cuticles are mostly impermeable to CO$_2$ and H$_2$O, stomata are the primary entry points through which gas exchange occurs despite making up a small percentage of the leaf area [@lange_responses_1971]. Stomata consist of two guard cells which open and close upon changes in turgor pressure or hormonal cues [@mcadam_linking_2016]. The stomatal pore leads to an internal space known as the substomatal cavity where gases contact the mesophyll. Once in the mesophyll, CO$_2$ diffuses throughout a network of intercellular air space (IAS) and into mesophyll cells where CO$_2$ assimilation ($A$) occurs within the chloroplasts [@lee_diffusion_1964]. Stomatal conductance and transpiration are determined by numerous environmental and anatomical parameters such as vapor pressure deficit (VPD), irradiance, temperature, wind speed, leaf water potential, IAS geometry, mesophyll cell anatomy, and stomatal anatomy.

Many successful predictions about stomata and other leaf traits can be made by hypothesizing that natural selection should optimizes CO$_2$ gain per unit of water loss [@cowan_stomatal_1977; @buckley_optimal_2017; @sperry_predicting_2017]. However, stomatal anatomy may be partially constrained by physical and developments limits on phenotypic expression [@croxdale_stomatal_2000; @harrison_influence_2020; @muir_how_2023]. Sometimes optimization leads to similar phenotypes across many disparate species. For example, almost all stomata follow the one cell spacing rule to maintain proper stomatal functioning [@geisler_oriented_2000; @dow_physiological_2014]; however some species (notably in *Begonia*) appear to benefit from overlapping vapor shells caused by stomatal clustering [@yi_gan_stomatal_2010; @lehmann_effects_2015; @papanatsiou_stomatal_2017]. Stomatal traits also vary adaptively in different environments. Stomatal density positively co-varies with irradiance during leaf development and negatively co-varies with CO$_2$ concentration [@gay_influence_1975; @schoch_dependence_1980; @woodward_stomatal_1987; @royer_stomatal_2001], consistent with optimality predictions. Stomatal size is jointly controlled by genome size, light, and stomatal density [@jordan_environmental_2015]. Size positively co-varies with genome size [@roddy_scaling_2020] and negatively co-varies with stomatal density [@camargo_density_2011]. Total stomatal area (size $\times$ density) is optimized for operational conductance ($gs_\text{s,op}$) rather than maximum conductance ($gs_\text{s,max}$) such that stomatal apertures are most responsive to changes in the environment at their operational aperture [@franks_physiological_2012; @liu_scaling_2021]. Stomatal aperture can compensate for maladaptive stomatal densities to an extent [@bussis_stomatal_2006], but stomatal density and size ultimately determine a leaf's theoretical $gs_\text{s,max}$ [@sack_developmental_2016], which is proportional to $gs_\text{s,op}$ [@murray_consistent_2020]. Additionally, low stomatal densities lead to irregular and insufficient CO$_2$ supply and reduced photosynthetic efficiency in areas far from stomata [@pieruschka_lateral_2006; @morison_lateral_2005], while high stomatal densities can reduce water use efficiency (WUE) [@bussis_stomatal_2006] and incur excessive metabolic costs [@deans_optimization_2020]. In most species, stomata occur on the abaxial (usually lower) leaf surface; but amphistomy, the occurrence of stomata on both abaxial and adaxial leaf surfaces, is also prevalent in high light environments with constant or intermittent access to sufficient water [@mott_adaptive_1982; @jordan_using_2014; @muir_light_2018; @drake_two_2019; @muir_is_2019]. Amphistomy effectively halves the CO$_2$ diffusion path length and boundary layer resistance by doubling boundary layer conductance [@parkhurst_adaptive_1978; @harrison_influence_2020; @mott_amphistomy_1991]. Historically, stomatal patterning in dicot angiosperms was thought to be random with an exclusionary distance surrounding each stomate [@sachs_developmental_1974]; however, the developmental controls of stomatal patterning are poorly understood and likely more complex than random development along the leaf surface. @croxdale_stomatal_2000] reviews three developmental theories which attempt to explain stomatal patterning in angiosperms: inhibition, cell lineage, and cell cycle, ultimately arguing for a cell cycle based control of stomatal patterning.

The patterning and spacing of stomata on the leaf affects photosynthesis in $C_3$ leaves by altering the CO$_2$ diffusion path length from stomata to sites of carboxylation in the mesophyll. Maximum photosynthetic rate ($A_\text{max}$) in $C_3$ plants is generally co-limited by biochemistry and diffusion, but modulated by light availability [@parkhurst_intercellular_1990; @manter_ci_2004; @carriqui_diffusional_2015]. Low light decreasing CO$_2$ demand by limiting electron transport rate, leading to relatively high internal CO$_2$ concentration ($C_\text{i}$) and low $A_\text{max}$ [@kaiser_metabolic_2016]. In contrast, well hydrated leaves with open stomata in high light, photosynthesis is often limited by CO$_2$ supply as resistances from the boundary layer, stomatal pore, and mesophyll can result in insufficient CO$C_2$ supply at the chloroplast to maxmimize photosynthesis [@farquhar_biochemical_1980; @lehmeier_cell_2017]. In this study, we focus primarily on how stomatal patterning affects diffusion, ignoring boundary layer and mesophyll resistances.

To maximize CO$_2$ supply from the stomatal pore to chloroplasts, stomata should be uniformly distributed in an equilateral triangular grid on the leaf surface so as to minimize stomatal number and CO$_2$ diffusion path length [@parkhurst_diffusion_1994]. As the diffusion rate of CO$_2$ though liquid is approximately $10^4\times$ slower than CO$_2$ diffusion through air, mesophyll resistance is generally thought to be primarily limited by liquid diffusion [@aalto_three-dimensional_2002; @evans_resistances_2009], but diffusion through the IAS has also been shown to be a rate limiting process because the tortuous, disjunct nature of the IAS can greatly increase diffusion path lengths [@harwood_understanding_2021]. Additionally, tortuosity is higher in horizontal directions (parallel to leaf surface) than vertical directions (perpendicular to leaf surface) because of the cylindrical shape and vertical arrangement of pallisade mesophyll cells [@earles_beyond_2018; @harwood_understanding_2021]. However, the ratio of lateral to vertical diffusion rate is still largely unknown [@morison_lateral_2005; @pieruschka_lateral_2005; @pieruschka_lateral_2006]. Depending on the thickness of the leaf, porosity of the leaf mesophyll, tortuosity of the IAS, and lateral to vertical diffusion rate ratio, minimizing diffusion path length for CO$_2$ via optimally distributed stomata may yield significant increases in CO$_2$ supply for photosynthesis and higher $A_\text{max}$.

We hypothesized that natural selection will favor stomatal patterning and distribution to minimize the diffusion path length. In amphistomatous leaves, this would be accomplished by 1) a uniform distribution of stomata on both abaxial and adaxial leaf surfaces and 2) coordinated stomatal spacing on each surface that offsets the position of stomata (Fig. \ref{fig:amphi_grid}). Coordination between leaf surfaces is defined in this study as the occurrence of stomata in areas farthest from stomata on the opposite leaf surface. Additionally, because CO$_2$ is more limiting for photosynthesis under high light, we hypothesize that in high light 3) there should be more stomata, and 4) stomata should be more uniformly distributed than in low light. Finally, as stomatal densities are selected for optimal operational aperture, we hypothesize that 5) stomatal length will be positively correlated with the area of the leaf surface to which it is closest. We refer to this as the 'stomatal zone', the leaf area surrounding a focal stomate closest to that stomate and therefore the zone it supplies with CO$_2$). This way, each stomate can be optimally sized relative to the mesophyll volume it supplies.

To test these hypotheses, we grew the model plant *Arabidopsis thaliana* in high, medium, and low light and measured stomatal density, size, and patterning on both leaf surfaces, and spatial coordination between them. We use Voronoi tessellation techniques to calculate stomatal zones. We also used a 2-D porous medium approximation of CO$_2$ diffusion and photosynthesis to predict the photosynthetic advantage of optimal versus suboptimal coordination in stomatal coordination between surfaces. Specifically, we predicted that traits which affect diffusion path length (leaf thickness, stomatal density, leaf porosity, lateral-vertical diffusion rate ratio), diffusion rate (temperature, pressure), and CO$_2$ demand (Rubisco concentration, light) would modulate the advantage of optimal stomatal arrangement following the relationships outlined in Table \ref{tab:hypotheses}. Here, we integrate over reasonable parameter space to determine the ecophysiological context most likely to favor stomatal spatial coordination in amphistomatous leaves.

```{r hypotheses, results="asis"}

df = tibble::tribble(
  ~trait, ~relationship,
  "leaf thickness", "+",
  "stomatal density", "-",
  "leaf porosity", "-", 
  "lat.-vert. diffusion ratio", "-", 
  "temperature", "-",
  "pressure", "-",
  "Rubisco concentration", "+",
  "light", "+"
)

# Creates tables that follow OUP guidelines using xtable
print(xtable::xtable(df, caption = "A summary of the hypothesized relationships between leaf traits and environmental conditions and photosynthetic advantage of stomatal spatial coordination in amphistomatous leaves.", label = "tab:hypotheses"),
      comment = FALSE)
```

# Materials and methods

## Data Preparation

[CDM: Graham Dow provided these images. We'll need to add him as a co-author and ask him to write methods on image acquisition.]

*Arabidopsis thaliana* plants were grown in three different light environments: low light (PAR = 50 $\mu \text{mol}~\text{m}^{-2}~\text{s}^{-1}$), medium light (100 $\mu \text{mol}~\text{m}^{-2}~\text{s}^{-1}$), and high light (200 $\mu \text{mol}~\text{m}^{-2}~\text{s}^{-1}$). PAR stands for photosynthetically active radiation. Once leaves were mature, we captured images of the abaxial and adaxial leaf surfaces using XXX. We captured 132 images in total, making 66 abaxial-adaxial image pairs. We measured stomatal position and size using ImageJ [@schneider_nih_2012].

## Single surface analyses

We tested whether stomata are non-randomly distributed by comparing the observed stomatal patterning to a random uniform pattern. For each leaf surface image with $n$ stomata we generated $10^3$ synthetic surfaces with $n$ stomata uniformly randomly distributed on the surface. For each sample image, we compared the observed Nearest Neighbor Index ($\mathrm{NNI}$) to the null distribution of $\mathrm{NNI}$ values calculated from the synthetic data set. $\mathrm{NNI}$ is the ratio of observed mean distance ($\overline{D}_O$) to the expected mean distance ($\overline{D}_E$) where $\overline{D}_E$ is:

\begin{equation}\label{eq:emd}
  \overline{D}_E = \frac{0.5}{\sqrt{A_\text{leaf} / n_\text{stomata}}}.
\end{equation}

\noindent $A_\text{leaf}$ is leaf area visible in the sampled field and $n_\text{stomata}$ the number of stomata. $\overline{D}_E$ is the theoretical average distance to the nearest neighbor of each stomate if stomata were uniformly randomly distributed [@clark_distance_1954]. $\overline{D}_O$ calculated for each synthetic data set is:

\begin{equation}\label{eq:omd}
  \overline{D}_O = \frac{\sum_{i=1}^{n_\text{stomata}}d_i}{n_\text{stomata}},
\end{equation}

\noindent where $d_i$ is the distance between $\text{stomate}_i$ and its nearest neighbor. We calculated $\mathrm{NNI}$ using the *R* package **spatialEco** version `r packageVersion("spatialEco")` [@evans_spatialeco_2023]. The observed stomatal distribution is dispersed relative to a uniform random distribution if the observed $NNI$ is greater than 95% of the synthetic $\mathrm{NNI}$ values (one-tailed test).

For each sample image, we also simulated $10^3$ synthetic data with $n$ stomata ideally dispersed in an equilateral triangular grid. For these grids, we integrated over plausible stomatal densities and then conditioned on stomatal grids with exactly $n$ stomata. The simulated stomatal count was drawn from a Poisson distribution with the mean parameter $\lambda$ drawn from a Gamma distribution with shape $n$ and scale 1 $\lambda \sim \Gamma(n, 1)$. $\Gamma(n, 1)$ is the posterior distribution of $\lambda$ with a flat prior distribution. This allows us to integrate over uncertainty in the stomatal density from the sample image. 

We developed a dispersion index $\mathrm{DI}$ to quantify how close observed stomatal distributions are to random uniform versus maximally dispered in an equilateral triangular grid. $\mathrm{DI}$ varies from zero to one, where zero is uniformly random and one is ideally dispersed:

\begin{equation}\label{eq:disp}
  \mathrm{DI} = \frac{\mathrm{NNI} - \text{median}(\mathrm{NNI_{random}})}{\text{median}(\mathrm{NNI_{uniform}}) - \text{median}(\mathrm{NNI_{random}})}
\end{equation}

\noindent $\mathrm{NNI}$ is calculated for each sample image as described above; $\text{median}(\mathrm{NNI_{random}})$ and $\text{median}(\mathrm{NNI_{uniform}})$ are calculated from the synthetic data specific to each sample image as described above. We tested whether light treatment affects $\mathrm{DI}$ and stomatla density ($D_S$) using analysis of variance (ANOVA).

<!-- CDM: I am not sure this part is needed
Uniformly distributed stomata on a leaf with stomatal density ($D_S$) maximize $\overline{D}_O$ in an equilateral triangle pattern with side lengths ($s$) equal to two times the incircle radius or apothem, $a$, of a regular hexagon with area ($A_\text{hex}$) equal to $A_\text{leaf}$ divided by the number of stomata ($n_\text{stomata}$) on the leaf according to Eq. \ref{eq:eq2}:

\begin{equation}\label{eq:eq2}
  s = \frac{\sqrt{2}} {3^{1/4} \sqrt{n_\text{stomata} / A_\text{leaf}}}
\end{equation}

As all sides of an equilateral triangle have the same length, the average nearest neighbor distance for a given $D_S$ is maximized and each stomate occupies the same hexagonal area ($A_\text{hex}$). As $DI$ approaches 1, the more uniform an area each of its stomata supply with CO$_2$ during photosynthesis. 
 -->
 
Finally, we examined the relationship between stomatal zone area and stomatal length using a Bayesian generalized non-linear multilevel model fit with the *R* package **brms** version `r fit$version$brms` [@burkner_brms_2017; @burkner_advanced_2018] and *Stan* version `r fit$version$cmdstan` [@stan_development_team_stan_2023]. Stomatal zone area was calculated using Voronoi tessellation (e.g. Fig. \ref{fig:example}). The stomatal zone area, $S_\text{area}$, is the region of the leaf surface whose distance to stomate, $S$, is less than the distance to any other stomate, $S$. Stomatal length was measured in ImageJ [@schneider_nih_2012].

## Paired Abaxial and Adaxial Surface Analysis

To test whether the position of ab- and adaxial stomata are coordinated we compared the observed distribution to a null distribution where the positions on each surface are random. For each pair of surfaces (observed or synthetic) we calculated the distance squared between each to the nearest stomatal centroid with the *R* package **raster** version `r packageVersion("raster")`. Then we calculated the cell-wise Pearson correlation coefficient. If stomatal positions on each surface are coordinated to minimize the distance between mesophyll and the nearest stomate, then we expect a negative correlation. A cell that is far from a stomate on one surface should be near a stomate on the other surface (Fig. \ref{fig:amphi}). We generated a null distribution of the correlation coefficient by simulating $10^3$ synthetic data sets for each observed pair. For each synthetic data set, we simulated stomatal position using a random uniform distribution, as described above, matching the number of stomata on abaxial and adaxial leaf surfaces. Stomatal positions on each surface are coordinated if the correlation coefficient is greater than 95% of the synthetic correlation values (one-tailed test).

## Modeling Photosynthesis

We modeled photosynthesis CO$_2$ assimilation rate using a spatially-explicit two-dimensional reaction diffusion model using a porous medium approximation [@parkhurst_intercellular_1994] using the finite element method (FEM) following @earles_excess_2017. Consider a two-dimensional leaf where stomata occur on each surface in a regular sequence with interstomatal distance $U$. The main outcome we assessed is the advantage of offsetting the position of stomata on each surface compared to have stomata on the same $x$ position on each surface. With these assumptions, by symmetry, we only need to model two stomata, one abaxial and one adaxial, from $x = 0$ to $x = U/2$ and from the adaxial surface at $y = 0$ to the abaxial surface at $y = L$, the leaf thickness. We arbitrarily set the adaxial stomate at $x = 0$ and toggled the abaxial stomata position between $x = U/2$ (offset) or $x = 0$ (below adaxial stomate). The 'coordination advantage' of offsett stomatal position on each surface is the photosynthetic rate of the leaf with offset stomata compared to that with stomata aligned in the same $x$ position:

\begin{equation} \label{eq:coordination_advantage}
  \text{coordination advantage} = \frac{A_\text{offset}}{A_\text{aligned}}
\end{equation}

We modeled the coordination advantage over a range of leaf thicknesses, stomatal densities, photosynthetic capacities, and light environments to understand when offsetting stomatal position on each surface might deliver a significant photosynthetic advantage (Table \ref{tab:model_var}).

```{r, model_var}
knitr::kable(model_var_table)
```

WORKING HERE - make table of parameter combinations!

### Light propogation model


Irradiance at depth $y$ in a leaf with thickness $L$ is modeled following Lloyd *et al.* (1992):

\begin{equation}\label{eq:light_propogation}
  I(y) = 1.1 I_0 e ^ {-2.4 y / L}
\end{equation}

where $I_0$ is photosynthetically active irradiance incident on the adaxial leaf surface.

### Biochemical model

All parameter symbols, units, descriptions, and values are described in Table X below. Following Gutschick (1984), we modeled photosynthetic rate per unit chlorophyll $A_\text{chl}$ then calculated the volumetric photosynthetic rate $A_\text{volume}$ by multiplying by the chlorophyll concentration $Q_\text{chl}$:

$$A_\text{volume} = A_\text{chl} Q_\text{chl}$$
A description of the model is given on page 553-556 of Gutschick (1984). The R code below is how we implemented the model. 

* `C_m` is a vector CO$_2$ concentrations in $\text{mmol m}^{-3}$ at different positions within the leaf
* `I_m` is a vector of irradiances in $\mu \text{mol m}^{-2} \text{s}^{-1}$ at different positions within the leaf (same order as `C_m`).
* `pars` is a list of parameters

```{r, echo = TRUE, eval = FALSE}

pars = list(

    P = set_units(101.325, kPa), # air pressure at sea level
    temp = set_units(298.15, K), # assume constant temperature
    R_gas = set_units(8.314, J/K/mol), # ideal gas constant

    # Calculations for C_a and O ued below
    # 21% O2
    # set_units(0.21 * P / (R_gas * temp), mol/m^3)
    # 415 ppm
    # set_units((415/1e6) * P / (R_gas * temp), mmol/m^3)

    # Environmental
    C_a = set_units(16.96367, mmol/m^3),
    O = set_units(8.584027, mol/m^3),
    PAR = set_units(1000, umol/m^2/s),

    # Biochemical
    E_t = set_units(0.01, mol/mol),
    eta_t = set_units(0.59, 1),
    k_c = set_units(20, mol/mol/s),
    k_o = set_units(4.2, mol/mol/s),
    K_c = set_units(0.0184, mol/m^3),
    K_o = set_units(13.2, mol/m^3),
    Q_chl = set_units(3.3, mol/m^3),
    R_p = set_units(0.273, mol/mol),

    # Diffusivity of CO2 in leaf airspace. From Gutschick 1984. Should be updated and include temperature dependence, effect of cell packing, tortuosity, etc.
    D_mc = set_units(7e-7, m^2/s)

)

# strip units to speed up calculation
upars = purrr::map(pars, ~ {if(inherits(.x, "units")) {drop_units(.x)}})

# multiply/divide by 1e3 because C_m is mmol and parameters are in mol
k_vc = upars[["k_c"]] / (1 + (1e3 * upars[["K_c"]] / C_m) *
                           (1 + upars[["O"]] / upars[["K_o"]])) # [1/s]
# Given light_propagation assumptions, k = 2.4/L assuming no scattering
k_i = 2.4 / upars[["leaf_thickness"]] # [1/um] # I'm not sure sure this is right
b_x = k_i * I_m # [mol/m^3/s]
a_x = b_x / upars[["Q_chl"]] # [1/s]
j = 0.5 * a_x * upars[["eta_t"]] # [1/s] # eqn 9
phi = upars[["k_o"]] / upars[["k_c"]] * (upars[["O"]] / upars[["K_o"]]) /
  (1e-3 * C_m / upars[["K_c"]]) # [1]
v_cj = j / (4 + 4 * phi) # [1/s]
v_cp = k_vc * upars[["R_p"]] # [1/s]
v_cr = apply(cbind(v_cj, v_cp), 1, min) # [1/s]
v_c = apply(cbind(k_vc * upars[["E_t"]], v_cr), 1, min) # [1/s]
v_o = phi * v_c # [1/s]
A_chl = v_c - 0.5 * v_o # [1/s] # i.e mol CO2 / mol Chl / s
A_volume = A_chl * upars[["Q_chl"]] # [mol/m^3/s]

```

To model photosynthesis and CO$_2$ transport within a two-dimensional cross section of the leaf, we built a grid of nodes of dimensions leaf thickness by half the interstomatal distance. Nodes represent the leaf mesophyll where CO$_2$ diffusion and assimilation occur. 

**Table X** Glossary of mathematical symbols. The columns indicate the mathematical Symbol used in the paper, the associated symbol used in R scripts, scientific Units, and a verbal Description.

 Symbol              | Value(s) | Units            | Description
---------|--------|--------------------------|----------------------------------
Biochemical Parameters |||
$A_\text{volume}$    | NA    | $mol CO_2/m^3/s$    | volumetric assimilation rate
$A_\text{chl}$       | NA    | $mol CO2/mol Chl/s$ | assimilation rate per mol chlorophyll
$E_t$                | 0.01  | $mol / mol Chl$     | rubisco octamer concentration per chlorophyll  
$eta_t$              | 0.59  | unitless            | quantum efficiency of photoexcitation transfer to reaction centers
$k_c$                | 20    | $mol CO2/mol Rubisco/s$ at 25 C | maximal carboxylation velocity of Rubisco
$k_o$                | 4.2   | $mol O2/mol Rubisco/s$ at 25 C | maximal oxygenation velocity of Rubisco
$K_c$                | 0.0184 | $mol/m^3$ at 25 C  | Michaelis constant for CO2
$K_o$                | 13.2  | $mol/m^3$ at 25 C   | Michaelis constant for O2
$J_\text{max}$       | 0.253 | $mol e\text{-}/mol Chl/s$ | maximal electron transport rate per mol Chl
$Q_\text{chl}$       | 3.3   | $mol/m^3$           | Chl volume concentration
$v_c$                | NA    | $mol CO2/mol Chl/s$ | carboxylation rate
$v_o$                | NA    | $mol O2/mol Chl/s$  | oxygenation rate
$k_\text{vc}$        | NA    | $mol CO2/mol Rubisco/mol Chl$ | carboxylation velocity per Rubisco octamer at ambient CO2
$R_p$                | 0.273 | $mol RuBP/mol Chl$  | RuBP pool size
$k_i$                | 2.4   | $1/m^2$ or $1/L$    | light attenuation coefficient
$D_\text{mc}$        | 7e-7  | $m^2/s$             | diffusivity of CO$_2$ in mesophyll airspace
Environmental Parameters |||
$P$                  | 101.325 | $kPa$             | air pressure at sea level
$temp$               | 298.15 | $K$                | temperature
$R_\text{gas}$       | 8.314 | $J/K/mol$           | ideal gas constant
$C_a$                | 16.96367 | $mmol CO_2/m^3$  | atmospheric CO$_2$ concentration
$O$                  | 8.584027 | $mol O_2/m^3$    | atmospheric $O_2$ concentration
$PAR$                | 1000  | $umol photons/m^2/s$ | photosynthetically active radiation
Variables |||
$U_s$                | .05, .10, .15... | $mm$     | interstomatal distance
$T_l$                | .1, .2, .3... | $mm$        | leaf thickness
$g_\text{sc}$        | 0.2, 0.3, 0.4... | $mol/m^2/s$ | stomatal conductance

## Two-dimensional model

We used the `steady.2D()` function in the *R* package **rootSolve** version `r packageVersion("rootSolve")` [@soetaert_practical_2009].

```{r, echo = TRUE, eval=FALSE}

diffusion2D <- function (time, state, pars, stomata_offset) {

  n_row = pars[["n_row"]]
  n_col = pars[["n_col"]]

  n_node = n_row * n_col

  node_length_m = node_length * 1e-6 # node_length in [m]

  # matrix of C_m values
  C_m_mat = matrix(nrow = n_row, ncol = n_col, state)

  # Photosynthetic demand
  ## Light matrix
  I_mat = seq(0, by = pars[["node_length"]], length.out = n_row) |>
    light_propogation(pars[["leaf_thickness"]], pars[["PAR"]]) |>
    matrix(n_row, ncol = n_col)

  ## Biochemical model
  # Units have to be correct for this to work, but unitless = TRUE should be faster
  A = biochemical_model(C_m_mat, I_mat, pars = pars, unitless = TRUE)

  ## Photosynthesis matrix
  ## multiply by 1000 to convert from mol / m^3 / s to mmol / m^3 / s
  A_mat = matrix(nrow = n_row, ncol = n_col, 1e3 * A)

  # CO2 diffusion
  C_a = drop_units(pars[["C_a"]])
  flux_mat = matrix(nrow = n_row, ncol = n_col, 0)
  flux_mat[1, 1] = pars[["g_sc"]] * (C_a - C_m_mat[1, 1])

  ## 1. Flux through stomata
  if (stomata_offset) {
    flux_mat[n_row, n_col] = pars[["g_sc"]] * (C_a - C_m_mat[n_row, n_col])
  } else {
    flux_mat[n_row, 1] = pars[["g_sc"]] * (C_a - C_m_mat[n_row, 1])
  }

  zero_x <- rep(0, n_row)
  zero_y <- rep(0, n_col)

  ## 2. Mesophyll flux; zero fluxes near boundaries
  flux_above = rbind(rep(0, n_col), C_m_mat[1:(n_row - 1), ] - C_m_mat[2:n_row, ])
  flux_below = rbind(C_m_mat[2:n_row, ] - C_m_mat[1:(n_row - 1), ], rep(0, n_col))
  flux_left  = cbind(rep(0, n_col), C_m_mat[, 1:(n_col - 1)] - C_m_mat[, 2:n_col])
  flux_right = cbind(C_m_mat[, 2:n_col] - C_m_mat[, 1:(n_col - 1)], rep(0, n_col))

  # g_mc [m/s] = D_mc [m^2/s] / node_length [m]
  flux_mat = flux_mat + pars[["g_mc"]] * (flux_above + flux_below + flux_left + flux_right)

    return(list(c(as.vector(flux_mat / node_length_m - A_mat))))

}

```

## Global Results

Stomatal density of *Arabidopsis thaliana* the 132 leaves measured ranged from 12 to 93 (units) with high light leaves ranging from 93 to 55 (units), medium light from 15 to 35 (units), and low light from 12 to 42 (units). Leaves were amphistomatous with a mean stomatal ratio of 0.45.

## Single Surface Results

If our hypotheses that natural selection will act to reduce the diffusion path length of CO$_2$ while minimizing stomatal number are correct, then we would expect to find leaf surfaces with uniformly distributed stomata. However, to the contrary, we find that though 57 of the 132 (43.1%) leaf surfaces were significantly more uniformly dispersed than uniform random synthetic stomatal grids ($\alpha$ = 0.05), none of the leaf surfaces exhibited perfectly uniform stomatal patterning (dispersion index = 1) (Fig. \ref{fig:dispersion}). Additionally, we hypothesized that as CO$_2$ is more limiting to photosynthesis under high light, stomata would be more uniformly dispersed in plants grown in high light than plants grown in low and medium light. The data also fail to support this hypothesis as there is no strong, discernible trend between light and stomatal patterning. Interestingly, adaxial leaf surfaces were more uniformly dispersed than associated abaxial leaf surfaces across all light treatments (F$_\text{1,126}$ = 28.8; p-value < 0.001). Rather than regulate stomatal patterning in response to light regimes, plants respond by increasing stomatal density (Fig. \ref{fig:density}). Stomatal density drastically increased in plants grown under high light, validating the long held hypothesis that light strongly influences stomatal density (F$_\text{2,126}$ = 680.7; p-value < 0.001).

Across all light treatments and leaf surfaces, stomatal length and stomatal area were weakly positively correlated, indicating some support for our hypothesis that stomata are selected for an optimal operational aperture (Fig. \ref{fig:length-area}).

## Dual Surface Analysis

As evidence against our hypothesis that natural selection should favor spatial coordination in the placement of stomata between abaxial and adaxial leaf surfaces, we found no correlation between paired abaxial and adaxial leaf surfaces (Fig. \ref{fig:dual-surface}). Light treatment had no effect on correlation between surfaces (F$_\text{2,63}$ = 2.28; p-value = 0.11). All but one abaxial, adaxial surface pairs were independent ($\alpha$ = 0.05).

### Example output

We wrapped the above functions to adjust environmental and anatomical variables. We're going to simulate over a grid of parameters, but here is what the output looks like plotted:


### DRAFT TEXT

During a model run, CO$_2$ flux between neighboring nodes was determined according to the mesophyll CO$_2$ concentration ($C_m$) in each node, distance between cells, temperature, pressure, and leaf porosity. Assimilation rate ($A$) in each node was determined by $A_\text{max}$, $c_i$, irradiance, temperature, chlorophyll volume concentration, Rubisco octamer concentration per mol chlorophyll, and maximal oxygenation and carboxylation rates of Rubisco. Stomata were placed either 1) directly on top of one another to represent anticoordination or 2) offset from one another to represent coordination between leaf surfaces. $c_i$ and CO$_2$ assimilation rate (A) were set to 415ppm and 0 respectively and the model ran until $c_i$ and A reached equilibrium in each cell. Total A and average $c_i$ were then calculated for each parameter combination.


A was calculated in terms of $A_\text{max}$ and $c_i$ following Eq. \ref{eq:eq4}

\begin{equation}\label{eq:eq4}
A = A_\text{max} * c_i / (c_i + K_c)
\end{equation}

where $K_c$ is the Michaelis constant for CO$_2$: 0.0184 mol $m^\text{-3}$.

$A_\text{max}$ was calculated in terms of irradiance (i), light saturated maximum A ($A_\text{mm}$), and quantum yield ($\varphi$) following Eq. \ref{eq:eq5}

\begin{equation}\label{eq:eq5}
A_\text{max} = A_\text{mm} * \varphi * i / (A_\text{mm} + \varphi * i)
\end{equation}

# Results

## Single surface analysis

\begin{figure}[ht]
\includegraphics[width=\textwidth]{figures/single-surface.pdf}
\caption{Stomata are more dispersed than expected under the null model of uniform random position (dispersion index = 0) but far from a distribution that maximizes distance between stomata (dispersion index = 1). Significant differences between light treatments are indicated by asterisks according to analysis of variance followed by a post-hoc tukey honest significant difference test ($\alpha$ = 0.05).}
\label{fig:dispersion}
\end{figure}

\begin{figure}[ht]
\includegraphics[width = \textwidth]{figures/density.pdf}
\caption{Stomatal density is higher in plants grown under high light conditions. Significant differences between light treatments are indicated by asterisks according to analysis of variance followed by a post-hoc tukey honest significant difference test ($\alpha$ = 0.05).}
\label{fig:density}
\end{figure}

\begin{figure}[ht]
\includegraphics[width = \textwidth]{figures/tessellation-example.pdf}
\caption{Examples of synthetic and real leaf surfaces.  A) Uniform random synthetic leaf surface; B) Example of real leaf surface; C) Regularly distributed synthetic leaf surface. The zone defined by each stomate was calculated with voronoi tessellation and correlated with stomatal length in real leaves.}
\label{fig:example}
\end{figure}

\begin{figure}[ht]
\includegraphics[width = \textwidth]{figures/length-area.pdf}
\caption{Stomatal length and stomatal zone area. Lines of best fit computed using a bayesian generalized non-linear multilevel model. Each light level and leaf surface exhibits a unique, weakly positive relationship between stomatal zone area and length.}
\label{fig:length-area}
\end{figure}

## Dual surface analysis

\begin{figure}[ht]
\includegraphics[width = \textwidth]{figures/ideal-amphi-grid.pdf}
\caption{Idealized amphistomatous stomatal grid with uniform stomatal patterning and perfect abaxial-adaxial coordination.}
\label{fig:amphi}
\end{figure}

\begin{figure}[ht]
\includegraphics[width = \textwidth]{figures/dual-surface.pdf}
\caption{Correlation between paired abaxial and adaxial leaf surfaces. Dashed line indicates no correlation. Weak positive correlations are not significantly different from null simulations. No differences in abaxial-adaxial correlation were observed between light levels according to an analysis of variance ($\alpha$ = 0.05).}
\label{fig:dual-surface}
\end{figure}

# Discussion

Stomata are expensive. A theoretical, optimized plant would minimize stomatal density while also allowing competitive gas exchange rates for its environment so as to maximize C assimilation per unit investment in stomata. Natural selection operates within developmental and physical constraints to drive each plant species toward its theoretical optimum. This study provides evidence that stomata in *Arbidopsis thaliana*, the model angiosperm, are non-randomly distributed, favoring dispersion over clustering (Fig. \ref{fig:dispersion}). However, stomata are not ideally dispersed in an equilateral triangular grid as would be optimal to minimize CO$_2$ diffusion path length and standardize the area supplied by each stomate (Fig. \ref{fig:example}). Additionally, when grown in high light environments, *A. thaliana* exhibited increased stomatal density rather than increased stomatal dispersion (Fig. \ref{fig:density}), which suggests that natural selection has acted more strongly on developmental pathways that modulate stomatal density than those that control stomatal dispersion. In other words, plants optimize gas exchange by adding more stomata rather than dispersing them more evenly across the leaf surface. This study also demonstrates that stomata that supply larger leaf areas with CO$_2$ tend to be larger (Fig. \ref{fig:length-area}). These results could suggest that 1) the added energetic and hydraulic cost of non-ideally dispersed stomata is negligible and therefore not acted on by natural selection; 2) no developmental pathway exists to ensure the ideal placement of stomata on the leaf; or 3) the regulation of stomatal size limits the cost incurred by non-ideal stomatal dispersion.

In high light environments, amphistomy is favorable as high light photosynthesis is limited by CO$_2$ and amphistomy halves diffusion path length and boundary layer resistance, thereby reducing CO$_2$ limitation - increasing theoretical $A_\text{max}$. An optimal amphistomatous leaf has offset stomata such that stomata are more likely to appear on one leaf surface if there is not a stomata directly opposite it on the other surface as shown in figure \ref{fig:amphi}. However, our results show that leaf surfaces are not coordinated but are independent, regardless of light (Fig. \ref{fig:dual-surface}). Additionally, gas exchange models show little photosynthetic efficiency gain from abaxial-adaxial stomatal coordination compared to anticoordination (INSERT FIG FROM MODELING). We posit that this marginal gain is not sufficient to be acted upon strongly by natural selection. Thus, amphistomatous plants do not exhibit abaxial-adaxial stomatal coordination for there is little selective advantage of it.

Our study corroborates previous studies which demonstrate that stomata are non-randomly distributed along the leaf surface as a result of developmental mechanisms such as spatially biased arrest of stomatal initials [@boetsch_arrest_1995], oriented asymmetric cell division [@geisler_oriented_2000], and cell cycle controls [@croxdale_stomatal_2000]. We do not investigate the potential developmental pathways that influence stomatal dispersion in this study; however, they are important to consider as these pathways could limit plants from reaching the theoretical peak in the adaptive landscape: uniform stomatal dispersion. Instead, as this study suggests, plants may simply compensate with higher stomatal density and by fitting stomatal size to the area that they supply with CO$_2$. To understand why stomata are not ideally dispersed, more modelling should be done to estimate the fitness gain of stomatal dispersion. Additionally, genetic manipulation studies should attempt to create mutants with clustered and ideally dispersed stomata for a comparison of their photosynthetic traits. This could have extremely important implications for maximum assimilation rates in crops as most crop species are grown in high light where CO$_2$ is often limiting. In drought-prone environments, increased stomatal dispersion may increase water use efficiency by reducing the number of stomata needed to achieve the same internal CO$_2$ concentration, $C_\text{i}$.

Beyond disperson on a single surface, gas exchange can be optimized via stomatal coordination of abaxial and adaxial surfaces in amphistomatous leaves. Given that leaf thicknesses are generally multiple times greater than interstomatal distance (GIVE DISTANCES HERE). As a result, abaxial-adaxial stomatal coordination reduces CO$_2$ diffusion path length far less than single surface dispersion, so we hypothesize this strategy to afford less photosynthetic advantage to the leaf. Our modelling results demonstrate that, even in ideal conditions, i.e. thick leaf, low stomatal densities, high light, low leaf porosity, high rubisco concentration, etc., the photosynthetic advantage of coordination is minimal. We are not surprised by these results, but still highlight them here as we are the first to report this finding.

Amphistomy is a unique and important adaptation found around the world across many plant lineages [@muir_light_2018], yet much of the dynamics of amphistomy remain poorly understood. Here, we show that in *Arabidopsis thaliana* 1) stomata in are non-randomly dispersed, but not ideally dispersed; 2) stomatal size and density are modulated by light; 3) stomatal size is positively correlated with the area to which it supplies CO$_2$; and 4) abaxial-adaxial stomatal coordination is not exhibited and is not shown to provide a strong photosynthetic advantage using CO$_2$ diffusion models. Interestingly, these findings did not validate many of our hypotheses which were based on first principles, suggesting that there may be limits on plants' ability to control stomatal placement. Future studies which elucidate these limitations may have important implications for agriculturaly productivity in a rapidly changing world.

# References
