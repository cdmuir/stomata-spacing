---
title: "2-D Photosynthesis Model"
format: pdf
editor: visual
bibliography: ../ms/stomata-spacing.bib
---

```{r, echo=FALSE}
knitr::opts_knit$set(root.dir = "..")
```

We model leaf photosynthesis using a two-dimensional porous medium approximation. The model is solved using a finite element method (FEM) using the `steady.2d()` function in the *R* package **rootSolve** version `r packageVersion("rootSolve")` [@soetaert_practical_2009]. Table S1 is a glossary model terms and symbols.

## Leaf anatomy

We assume that the leaf is a homogenous 2-D medium. The mesophyll is $T_\text{leaf}$ thick and the stomata are regularly spaced apart by distance $U$ on both ab- and adaxial surfaces. In this scenario, we assume that the stomata on each surface are precisely offset from each other by distance $U/2$. This minimizes the average distance between any point in the mesophyll and its nearest stomate. Because of the regular spacing, we only need to model the region between a stomate on surface and the next stomate on the other surface (Fig. S1). The rest of the mesophyll will be the same because of symmetry.

```{r, header, echo=FALSE, message=FALSE}

library(dplyr)
library(ggforce)
library(ggplot2)
library(glue)
library(readr)
library(stringr)
library(tidyr)

source("r/functions.R")

parms = read_csv("raw-data/2d-pm-parameters.csv")
ph2d_offset = read_rds("objects/ph2d_offset.rds")

```

```{r, fig1, message = FALSE, fig.cap='Example leaf anatomy analyzed by the 2-D FEM.', echo = FALSE, fig.height=6, fig.width=3}

# Example leaf where leaf thickness equals interstomatal distance
 xz_ratio = 0.5

  df_stomata = crossing(
    nesting(x = c(0, 1), y = c(0, 1) / xz_ratio),
    r = 0.04,
    x_offset = c(-1.5, 1.5)
  ) |>
    mutate(x0 = x + x_offset * r)

  df_epidermis = df_stomata |>
    summarise(stomata_min = min(x0 - r), stomata_max = max(x0 + r), .by = "y") |>
    mutate(
      xmin = ifelse(stomata_min < 0, stomata_max, 0),
      xmax = ifelse(stomata_max > 1, stomata_min, 1)
    )

  ggplot() +
    geom_circle(data = df_stomata, mapping = aes(x0 = x0, y0 = y, r = r)) +
    geom_segment(data = df_epidermis,
                 mapping = aes(
                   x = xmin,
                   xend = xmax,
                   y = y,
                   yend = y
                 ), linewidth = 1.5) +
    geom_text(
      data = df_stomata |>
        select(x, y) |>
        distinct(),
      mapping = aes(x, y, label = "stomate"),
      position = position_nudge(y = c(-0.05, 0.05) / xz_ratio)
    ) +
    geom_text(
      mapping = aes(x = 0.5, y = c(-0.1, 0.5, 1.1) / xz_ratio, label = c("abaxial", "mesophyll", "adaxial"))
    ) +
    geom_segment(mapping = aes(x = 0, y = -0.15 / xz_ratio, xend = 1, yend = -0.15 / xz_ratio),
                 arrow = arrow(angle = 90, length = unit(0.0125 / xz_ratio, "npc"), ends = "both") ) +
    geom_segment(mapping = aes(x = -0.15, y = 0 / xz_ratio, xend = -0.15, yend = 1 / xz_ratio),
                 arrow = arrow(angle = 90, length = unit(0.0125 / xz_ratio, "npc"), ends = "both") ) +
    geom_text(mapping = aes(x = 0.5, y = -0.2 / xz_ratio, label = "paste(italic(U) / 2, ', half the interstomatal distance [', mu, 'm]')"),
              parse = TRUE) +
    geom_text(mapping = aes(x = -0.2, y = 0.5 / xz_ratio, label = "paste(italic(T)[leaf], ', leaf thickness [', mu, 'm]')"),
              parse = TRUE, angle = 90) +
    coord_equal(clip = "off") +
    theme_void()
    
```

```{r, glossary, echo = FALSE, message = FALSE}

parms |>
  # filter(!calculated) |>
  mutate(Value = glue::glue("${x}$", x = scientize(default_value))) |>
  select(Name = name, Symbol = symbol, Value, Units = units, Notes = notes) |>
  knitr::kable(caption = "Table 1: glossary of model terms and mathematical symbols.")

```

## Solving within gradients in CO$_2$ assimilation and concentration

We extended the 1-D FEM of @earles_excess_2017 to solve a set of partial differential equations describing CO$_2$ diffusion, photosynthesis, and respiration throughout a 2-D leaf geometry. The diffusive flux of CO$_2$ through ab- and adaxial stoamta, intercellular airspace, and mesophyll cells was described by:

$$D_\text{e} \frac{\partial^2 C_\text{ias}}{\partial x^2} = -f_\text{liq}$$ {#eq-1d_pm_flux}

$$f_\text{liq} = r_\text{d} + r_\text{d} - r_\text{c}$$ {#eq-1d_pm_fliq}

where

$$
D_\text{e} = \frac{\phi}{\tau} D_\text{c}
$$ {#eq-De}

is the effective diffusivity of CO$_2$ though a porous medium composed of an intercellular airspace with a porosity ($\phi$; m$^3$ m$^{-3}$) and tortuosity ($\tau$; m m$^{-1}$). $D_\text{c}$ is the diffusion coefficient (m s$^{-1}$) for CO$_2$ in the intercellular airspace, $C_\text{ias}$ is the \[CO$_2$\] (mol m$^{-3}$) at depth $z$ in the intercellular airspace, $f_\text{liq}$ is the volumetric rate of CO$_2$ diffusion from the intercellular airspace into the chloroplast stroma (mol m$^{-3}$ s$^{-1}$), $r_\text{c}$ is the volumetric rate of ribulose 1,5-bisphosphate (RuBP) carboxylation (mol m$^{-3}$ s$^{-1}$), $r_\text{d}$ is the volumetric respiration rate (mol m$^{-3}$ s$^{-1}$), and $r_\text{p}$ is the volumetric photorespiration rate by Rubisco (mol m$^{-3}$ s$^{-1}$).

The volumetric rate of CO$_2$ diffusion from the intercellular airspace into the chloroplast stroma, $f_\text{liq}$, is defined as:

$$f_\text{liq} = \frac{g_\text{liq} (C_\text{liq} - C_\text{ias})}{l_z}$$ {#eq-fliq1}

where $g_\text{liq}$ is the CO$_2$ conductance from the intercellular airspace into the chloroplast stroma (m s$^{-1}$), $C_\text{liq}$ (mol m$^{-3}$) is the \[CO$_2$\] in the stroma, and $l_z$ is the finite element length through which diffusion occurs (m)." (n.b. $l_z$ is the same as $t_\text{elem}$ in my Table 1)

In the 2-D model, we extend the flux equation to $x$ (length) and $z$ (depth) dimensions:

$$D_\text{e} \nabla^2 C_\text{ias} = D_\text{e} \bigg(\frac{\partial^2 C_\text{ias}}{\partial x^2} + \frac{\partial^2 C_\text{ias}}{\partial z^2}\bigg) = -f_\text{liq}$$ {#eq-2d_pm_flux}

As I worked through @earles_excess_2017 model, it did not seem like dividing $g_\text{liq}$ by $l_z$ in equation @eq-fliq1 made sense. The FEM is a discretization of a continuous model. Intuitively, it does make sense why a coarser grid (greater $l_z$) would lead to a larger \[CO$_2$\] drawdown for a given assimilation rate. Noting that $g_\text{liq}$ is conductance per m$^2$ of stroma, this means the length scale to divide by should be 1/(stroma area per unit bulk leaf volume). This is equivalent to 1/\[(stroma area per leaf area)x(leaf area per bulk leaf volume)\] = 1/\[Sc x (1/Tleaf)\] = Tleaf/Sc (for now I am assuming Sm = Sc, but we can correct this later). Our equation is therefore:

$$f_\text{liq} = \frac{g_\text{liq} (C_\text{liq} - C_\text{ias})}{T_\text{leaf} / S_\text{m}}$$ {#eq-fliq2}

I calculated assimilation and respiration the same way as @earles_excess_2017 using the standard C\$\_3\$ biochemical model.

The boundary conditions are that the CO$_2$ concentration in the substomatal cavity is constant at $C_\text{stom}$. The fluxes on the left and right sides are 0 because of symmetry.

## R code

I've copied the *R* code to set up the model and solve it if you want to copy and paste on your own machine. I annotated the *R* code you would need to run the model and include an example result.

```{r}

# Variables
vars1 = read_rds("objects/model_var.rds") |>
  left_join(rename(parms, Variable = symbol), by = join_by(Variable))

vars2 = ph2d_offset$parms[pull(vars1, r)] |>
  as_tibble() |>
  pivot_longer(everything(), names_to = "r") |>
  full_join(vars1, by = join_by(r)) |>
  mutate(
    # convert from model unit to print unit
    value1 = case_when(
      r == "I_0" ~ value * 1e6,
      r == "phi_pal" ~ value,
      r == "T_leaf" ~ value * 1e6 - 1,
      r == "U" ~ 2 * (value * 1e6 - 1)
    )
  )

vars3 = vars2 |>
  transmute(
    s = glue("{var} = {value1}$ {Units}", var = str_remove(Variable, "\\$$"))
  ) |>
  pull(s) |>
  str_c(collapse = "; ")

# Guide to symbols
symbols = parms |>
  filter(r %in% c("C_ias", "C_liq", "I_0", "phi_pal", "T_leaf", "U")) |>
  transmute(s = glue("{symbol} = {name}")) |> 
  pull(s) |>
  str_c(collapse = "; ")

```

extra words

![Example profiles of volumetric CO$_2$ concentrations within otherwise identical amphistomatous leaves that have stomatal positions offset (top row) or aligned (bottom row) based on the 2-D porous medium model. When stomata are aligned, both ab- and adaxial stomata are position 0 along the $x$-axis; when stomata are offset, the adaxial stomate is positioned $U/2$ distance away. In this example, variables are set as: `r vars3`. All other parameter values are described in Table S1. `r symbols`.](figures/ph2d-example.pdf){fig-align="center"}

## References
